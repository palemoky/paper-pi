#!/bin/sh
# Pre-commit hook for Python code formatting and linting

# è·å– Git ä»“åº“çš„æ ¹ç›®å½•
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

printf "ğŸ” Checking staged Python files...\n"

# æŸ¥æ‰¾å·²æš‚å­˜çš„ Python æ–‡ä»¶
staged_py_files=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.py$")

# å¦‚æœæ²¡æœ‰ Python æ–‡ä»¶è¢«æš‚å­˜ï¼Œç›´æ¥é€€å‡º
if [ -z "$staged_py_files" ]; then
    printf "âœ… No Python files to check\n"
    exit 0
fi

printf "ğŸ“ Found Python files to format:\n"
printf "%s\n" "$staged_py_files"

# è¿è¡Œ black æ ¼å¼åŒ–
printf "\n"
printf "ğŸ¨ Running black...\n"
if ! black --check $staged_py_files 2>&1; then
    printf "âš ï¸  Code needs formatting. Auto-formatting...\n"
    black $staged_py_files
    # é‡æ–°æš‚å­˜æ ¼å¼åŒ–åçš„æ–‡ä»¶
    echo "$staged_py_files" | xargs git add
    printf "âœ… Files formatted with black\n"
fi

# è¿è¡Œ isort æ•´ç†å¯¼å…¥
printf "\n"
printf "ğŸ“¦ Running isort...\n"
if ! isort --check $staged_py_files 2>&1; then
    printf "âš ï¸  Imports need sorting. Auto-sorting...\n"
    isort $staged_py_files
    # é‡æ–°æš‚å­˜æ’åºåçš„æ–‡ä»¶
    echo "$staged_py_files" | xargs git add
    printf "âœ… Imports sorted with isort\n"
fi

# è¿è¡Œ ruff æ£€æŸ¥ä»£ç è´¨é‡
printf "\n"
printf "ğŸ” Running ruff...\n"
if ! ruff check $staged_py_files; then
    printf "âŒ Ruff found issues. Please fix them before committing.\n"
    printf "ğŸ’¡ Tip: Run 'ruff check --fix' to auto-fix some issues\n"
    exit 1
fi

printf "\n"
printf "âœ… All checks passed! Ready to commit.\n"
exit 0