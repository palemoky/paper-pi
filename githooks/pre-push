#!/bin/bash
# Pre-push hook for Python projects
# Runs pytest on staged Python files before pushing

set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

printf "${BLUE}ğŸš€ Running pre-push checks...${NC}\n"

# è·å– Git ä»“åº“çš„æ ¹ç›®å½•
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

printf "${BLUE}ğŸš€ Pre-push: Checking Python changes...${NC}\n"

# Git åœ¨ pre-push é’©å­ä¸­é€šè¿‡æ ‡å‡†è¾“å…¥æä¾›è¦æ¨é€çš„å¼•ç”¨ä¿¡æ¯
while read local_ref local_sha remote_ref remote_sha; do
    # è·³è¿‡ tag æ¨é€
    if [[ "$remote_ref" =~ ^refs/tags/ ]]; then
        printf "${YELLOW}â­ï¸  Skipping tests for tag push: $remote_ref${NC}\n"
        continue
    fi

    # å¦‚æœæ˜¯åˆ é™¤åˆ†æ”¯æ“ä½œï¼Œè·³è¿‡
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    # ç¡®å®šè¦æ£€æŸ¥çš„æäº¤èŒƒå›´
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # æ–°åˆ†æ”¯ï¼šæ£€æŸ¥æ‰€æœ‰æäº¤
        commit_range="$local_sha"
    else
        # æ›´æ–°åˆ†æ”¯ï¼šæ£€æŸ¥æ–°æ—§æäº¤ä¹‹é—´çš„å·®å¼‚
        commit_range="$remote_sha..$local_sha"
    fi

    printf "${CYAN}ğŸ“ Checking commits: $commit_range${NC}\n"

    # è·å–è¯¥èŒƒå›´å†…æ‰€æœ‰è¢«ä¿®æ”¹çš„æ–‡ä»¶
    changed_files=$(git diff-tree --no-commit-id --name-only -r "$commit_range")

    # æ£€æŸ¥æ˜¯å¦æœ‰ Python æ–‡ä»¶è¢«ä¿®æ”¹
    if echo "$changed_files" | grep -q "\.py$"; then
        printf "${YELLOW}ğŸ Detected Python file changes. Running tests...${NC}\n"
        printf "\n"

        # è¿è¡Œ pytestï¼ˆå¹¶å‘ï¼‰
        printf "${BLUE}ğŸ§ª Running pytest with parallel execution...${NC}\n"
        if ! PYTHONPATH=. pytest -n auto tests/; then
            printf "\n"
            printf "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
            printf "${RED}âŒ ERROR: Python tests failed.${NC}\n"
            printf "${RED}Push aborted. Please fix the tests before pushing.${NC}\n"
            printf "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
            exit 1
        fi

        printf "\n"
        printf "${GREEN}âœ… All Python tests passed!${NC}\n"
    else
        printf "${CYAN}â„¹ï¸  No Python files changed, skipping tests.${NC}\n"
    fi
done

printf "\n"
printf "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
printf "${GREEN}âœ… All checks passed. Proceeding with push.${NC}\n"
printf "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
exit 0