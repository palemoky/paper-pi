#!/bin/bash
# Pre-push hook for Python projects
# Runs pytest on staged Python files before pushing

set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš€ Running pre-push checks...${NC}"

# è·å– Git ä»“åº“çš„æ ¹ç›®å½•
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

echo "${BLUE}ğŸš€ Pre-push: Checking Python changes...${NC}"

# Git åœ¨ pre-push é’©å­ä¸­é€šè¿‡æ ‡å‡†è¾“å…¥æä¾›è¦æ¨é€çš„å¼•ç”¨ä¿¡æ¯
while read local_ref local_sha remote_ref remote_sha; do
    # è·³è¿‡ tag æ¨é€
    if [[ "$remote_ref" =~ ^refs/tags/ ]]; then
        echo "${YELLOW}â­ï¸  Skipping tests for tag push: $remote_ref${NC}"
        continue
    fi

    # å¦‚æœæ˜¯åˆ é™¤åˆ†æ”¯æ“ä½œï¼Œè·³è¿‡
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    # ç¡®å®šè¦æ£€æŸ¥çš„æäº¤èŒƒå›´
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # æ–°åˆ†æ”¯ï¼šæ£€æŸ¥æ‰€æœ‰æäº¤
        commit_range="$local_sha"
    else
        # æ›´æ–°åˆ†æ”¯ï¼šæ£€æŸ¥æ–°æ—§æäº¤ä¹‹é—´çš„å·®å¼‚
        commit_range="$remote_sha..$local_sha"
    fi

    echo "${CYAN}ğŸ“ Checking commits: $commit_range${NC}"

    # è·å–è¯¥èŒƒå›´å†…æ‰€æœ‰è¢«ä¿®æ”¹çš„æ–‡ä»¶
    changed_files=$(git diff-tree --no-commit-id --name-only -r "$commit_range")

    # æ£€æŸ¥æ˜¯å¦æœ‰ Python æ–‡ä»¶è¢«ä¿®æ”¹
    if echo "$changed_files" | grep -q "\.py$"; then
        echo "${YELLOW}ğŸ Detected Python file changes. Running tests...${NC}"
        echo ""

        # è¿è¡Œ pytest
        echo "${BLUE}ğŸ§ª Running pytest...${NC}"
        if ! PYTHONPATH=. pytest tests/; then
            echo ""
            echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo "${RED}âŒ ERROR: Python tests failed.${NC}"
            echo "${RED}Push aborted. Please fix the tests before pushing.${NC}"
            echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            exit 1
        fi

        echo ""
        echo "${GREEN}âœ… All Python tests passed!${NC}"
    else
        echo "${CYAN}â„¹ï¸  No Python files changed, skipping tests.${NC}"
    fi
done

echo ""
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}âœ… All checks passed. Proceeding with push.${NC}"
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
exit 0